generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL_UNPOOLED")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model Users {
  id          String     @id @default(cuid())
  address     String     @unique
  auditeeRole Boolean    @default(false)
  auditorRole Boolean    @default(false)
  name        String?
  image       String?
  available   Boolean    @default(false)
  auditors    Auditors[]
  auditees    Audits[]
  updatedAt   DateTime   @updatedAt
  createdAt   DateTime   @default(now())
}

enum AuditStatus {
  DISCOVERY // discovery phase
  ATTESTATION // audit is locked, auditors attest to terms
  AUDITING // auditors are auditing, can submit findings. Auditee implements findings
  CHALLENGEABLE // vesting has begun, users can challenge status
  FINALIZED // audit is complete and cannot be challenged
}

model Audits {
  id          String      @id @default(cuid())
  auditeeId   String
  auditee     Users       @relation(fields: [auditeeId], references: [id], onDelete: Cascade)
  title       String
  description String
  details     String? // references blob storage URL
  price       Int         @default(0)
  duration    Int         @default(6) // duration in months
  status      AuditStatus @default(DISCOVERY)
  auditors    Auditors[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

enum AuditorStatus {
  VERIFIED
  REQUESTED
  REJECTED
}

model Auditors {
  auditId       String
  audit         Audits        @relation(fields: [auditId], references: [id], onDelete: Cascade)
  userId        String
  user          Users         @relation(fields: [userId], references: [id], onDelete: Cascade)
  status        AuditorStatus
  attestedTerms Boolean       @default(false)
  acceptedTerms Boolean       @default(false)
  findings      String? // references blob storage URL

  @@unique([auditId, userId])
}
